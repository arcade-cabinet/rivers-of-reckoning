[tox]
envlist = py310, py311, py312, py313, py314, lint, docs, web, release
isolated_build = True
requires =
    tox>=4.0
    tox-uv>=1.0
    tox-gh-actions>=3.0

[gh-actions]
python =
    3.10: py310
    3.11: py311
    3.12: py312
    3.13: py313
    3.14: py314

[testenv]
runner = uv-venv-lock-runner
deps =
    pytest>=9.0.2
    pygame-ce>=2.5.0
commands =
    pytest tests/test_library_structure.py tests/test_game_logic.py tests/test_game_integration.py tests/test_sprite_generation.py -v

[testenv:lint]
runner = uv-venv-lock-runner
deps =
    flake8>=7.3.0
    black>=24.0.0
commands =
    black --check src/ tests/ main.py
    flake8 src/ tests/ main.py --max-line-length=127

[testenv:format]
runner = uv-venv-lock-runner
deps =
    black>=24.0.0
commands =
    black src/ tests/ main.py

[testenv:docs]
runner = uv-venv-lock-runner
description = Build Sphinx documentation
changedir = docs
extras = docs
commands =
    sphinx-build -b html . _build/html
    python -c "print('\n✓ Documentation built successfully at docs/_build/html/index.html')"

[testenv:web]
runner = uv-venv-lock-runner
description = Build web version with pygbag
extras = web
commands =
    # Clean previous builds
    python -c "import shutil; shutil.rmtree('build', ignore_errors=True)"
    # Build with pygbag
    python -m pygbag --build .
    # Verify build output
    python -c "import os; assert os.path.exists('build/web/index.html'), 'Web build failed: index.html not found'"
    python -c "print('\n✓ Web build successful at build/web/index.html')"

[testenv:web-serve]
runner = uv-venv-lock-runner
description = Build and serve web version locally
deps =
    pygbag>=0.9.2
    pygame-ce>=2.5.0
commands =
    python -m pygbag .

[testenv:e2e]
runner = uv-venv-lock-runner
description = End-to-end tests with playwright (requires web build)
deps =
    pytest>=9.0.2
    pytest-playwright>=0.7.0
    pytest-base-url>=2.1.0
    pygbag>=0.9.2
    pygame-ce>=2.5.0
passenv =
    CI
    PLAYWRIGHT_BROWSERS_PATH
commands_pre =
    # Build web version first
    python -m pygbag --build .
    # Install playwright browsers (only if not in CI)
    python -c "import os; os.system('playwright install chromium') if not os.environ.get('CI') else None"
commands =
    pytest tests/test_e2e.py -v --base-url=file://{toxinidir}/build/web

[testenv:release]
runner = uv-venv-lock-runner
description = Complete release pipeline: tests -> docs -> web -> e2e
deps =
    pytest>=9.0.2
    pytest-playwright>=0.7.0
    pytest-base-url>=2.1.0
    pygame-ce>=2.5.0
    pygbag>=0.9.2
    sphinx>=7.0.0,<9.0.0
    sphinx-rtd-theme>=2.0.0,<4.0.0
    black>=24.0.0
    flake8>=7.3.0
passenv =
    CI
    PLAYWRIGHT_BROWSERS_PATH
commands =
    # 1. Code quality checks
    python -c "print('\n=== STEP 1: Code Quality ===')"
    black --check src/ tests/ main.py
    flake8 src/ tests/ main.py --max-line-length=127
    
    # 2. Run unit tests
    python -c "print('\n=== STEP 2: Unit Tests ===')"
    pytest tests/test_library_structure.py tests/test_game_logic.py tests/test_game_integration.py tests/test_sprite_generation.py -v
    
    # 3. Build documentation
    python -c "print('\n=== STEP 3: Documentation ===')"
    sphinx-build -b html docs docs/_build/html
    
    # 4. Build web version
    python -c "print('\n=== STEP 4: Web Build (pygbag) ===')"
    python -c "import shutil; shutil.rmtree('build', ignore_errors=True)"
    python -m pygbag --build .
    python -c "import os; assert os.path.exists('build/web/index.html'), 'Web build failed'"
    
    # 5. E2E tests (if not in CI)
    python -c "print('\n=== STEP 5: E2E Tests ===')"
    python -c "import os; os.system('playwright install chromium --with-deps') if not os.environ.get('CI') else print('Skipping browser install in CI')"
    pytest tests/test_e2e.py -v --base-url=file://{toxinidir}/build/web --tb=short || python -c "print('⚠ E2E tests skipped or failed (may need browser install)')"
    
    # 6. Summary
    python -c "print('\n' + '='*60); print('✓ RELEASE PIPELINE COMPLETE'); print('='*60); print('  • Code quality: PASSED'); print('  • Unit tests: PASSED'); print('  • Documentation: BUILT'); print('  • Web build: READY'); print('  • Artifacts:'); print('    - docs/_build/html/'); print('    - build/web/'); print('='*60)"
